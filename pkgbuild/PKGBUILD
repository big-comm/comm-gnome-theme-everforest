# Maintainer: Narayan Silva <narayan.song@gmail.com>

pkgname=comm-gnome-theme-everforest
pkgdesc="Everforest Medium Dark GNOME theme with GTK and wallpaper"
pkgver=$(date +%y.%m.%d)
pkgrel=$(date +%H%M)
arch=('any')
license=('MIT')
url="https://github.com/big-comm/${pkgname}"
depends=('gtk3' 'gtk4' 'gnome-shell' 'gtk-engine-murrine')
makedepends=('git' 'sassc')
optdepends=('gnome-tweaks: For additional customization'
            'heif: For AVIF wallpaper conversion'
            'libreoffice: For integrated theme support')

source=(
    "git+https://github.com/Fausto-Korpsvart/Everforest-GTK-Theme.git"
    "git+${url}.git"
)
sha256sums=('SKIP' 'SKIP')

_theme_variant='Everforest-Dark-Medium'
_theme_target='Everforest-Dark-Medium-B'

# Automatically detect and use the correct install file
if [ -e "${pkgname}.install" ]; then
    install=${pkgname}.install
elif [ -e "pkgbuild.install" ]; then
    install=pkgbuild.install
fi

prepare() {
    cd "${srcdir}/${pkgname}" || return 1
}

build() {
    local theme_build="${srcdir}/theme-build"

    rm -rf "${theme_build}"
    install -d "${theme_build}"

    cd "${srcdir}/Everforest-GTK-Theme/themes" || return 1
    ./install.sh --dest "${theme_build}" --color dark --tweaks medium
}

check() {
    cd "${srcdir}/${pkgname}" || return 1
    local theme_build="${srcdir}/theme-build"

    # Verify theme directories exist in the build output
    if [ ! -d "${theme_build}/${_theme_target}" ] && \
       [ ! -d "${theme_build}/${_theme_variant}" ]; then
        echo "Warning: Checking available theme directories..."
        find "${theme_build}" -maxdepth 1 -type d -name "Everforest*" | head -5
        return 0  # Don't fail, just warn
    fi
}

package() {
    local theme_build="${srcdir}/theme-build"

    # Install GTK theme
    install -d "${pkgdir}/usr/share/themes"
    
    # Find the theme directory
    local theme_source
    if [ -d "${theme_build}/${_theme_target}" ]; then
        theme_source="${theme_build}/${_theme_target}"
    elif [ -d "${theme_build}/${_theme_variant}" ]; then
        theme_source="${theme_build}/${_theme_variant}"
    else
        theme_source=$(find "${theme_build}" -maxdepth 1 -type d -name "Everforest-Dark-Medium*" | sort | tail -1)
    fi
    
    if [ -z "${theme_source}" ] || [ ! -d "${theme_source}" ]; then
        echo "Error: Could not find Everforest theme directory"
        return 1
    fi
    
    cp -r "${theme_source}" "${pkgdir}/usr/share/themes/${_theme_target}"

    # Install helper script and assets
    install -Dm755 "${srcdir}/${pkgname}/install.sh" \
        "${pkgdir}/usr/share/${pkgname}/install.sh"

    if [ -d "${srcdir}/${pkgname}/usr/share" ]; then
        find "${srcdir}/${pkgname}/usr/share" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.heic" -o -iname "*.avif" \) | while read -r wallpaper; do
            install -Dm644 "${wallpaper}" \
                "${pkgdir}/usr/share/backgrounds/${pkgname}/$(basename "${wallpaper}")"
        done
    fi

    # Install docs and license
    install -Dm644 "${srcdir}/${pkgname}/README.md" \
        "${pkgdir}/usr/share/doc/${pkgname}/README.md"
    install -Dm644 "${srcdir}/${pkgname}/LICENSE" \
        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

    # Fix index.theme
    local theme_index="${pkgdir}/usr/share/themes/${_theme_target}/index.theme"
    if [ -f "${theme_index}" ]; then
        sed -i "s/^GtkTheme=.*/GtkTheme=${_theme_target}/" "${theme_index}"
        sed -i "s/^MetacityTheme=.*/MetacityTheme=${_theme_target}/" "${theme_index}"
    fi

    # --------------------------------------------------------------------------
    # [ENHANCED] Apply comprehensive CSS fixes for better GTK4 application support
    # --------------------------------------------------------------------------
    local gtk4_css="${pkgdir}/usr/share/themes/${_theme_target}/gtk-4.0/gtk.css"
    local gtk3_gtkrc="${pkgdir}/usr/share/themes/${_theme_target}/gtk-3.0/gtkrc"
    
    if [ -f "${gtk4_css}" ]; then
        echo "Applying GTK4 CSS enhancements for better app compatibility..."
        cat >> "${gtk4_css}" <<'EOF'

/* =============================================================================
 * Custom fixes for comm-gnome-theme-everforest
 * Ensures compatibility with GTK4 applications, particularly LibreOffice
 * and GTK File Chooser dialogs that use modern Libadwaita components
 * ============================================================================= */

/* Fix for Libadwaita AdwPreferencesGroup (Loupe, GNOME Settings, etc) */
AdwPreferencesGroup .title {
    color: #2d353b;
}

AdwPreferencesGroup .subtitle {
    color: rgba(255, 251, 239, 0.7);
}

/* Ensure file chooser dialogs inherit dark theme properly */
.dialog {
    background-color: @theme_bg_color;
    color: @theme_fg_color;
}

.dialog-action-area {
    background-color: @theme_bg_color;
}

/* Fix for LibreOffice and other apps using native file pickers */
filechooser window,
filechooser .background {
    background-color: @theme_bg_color;
    color: @theme_fg_color;
}

filechooser sidebar {
    background-color: shade(@theme_bg_color, 0.95);
}

filechooser .sidebar:backdrop {
    background-color: shade(@theme_bg_color, 0.9);
}

/* Ensure popovers and menus respect dark theme */
popover,
.popover {
    background-color: @theme_bg_color;
    color: @theme_fg_color;
}

/* GTK File Chooser search entry */
searchentry,
.search {
    background-color: shade(@theme_bg_color, 1.02);
    color: @theme_fg_color;
}

searchentry:focus,
.search:focus {
    background-color: shade(@theme_bg_color, 1.05);
    outline: 2px solid @accent_color;
}

/* Ensure path bar stays dark */
.path-bar,
pathbar {
    background-color: shade(@theme_bg_color, 0.98);
    color: @theme_fg_color;
}

/* Fix for column headers in file list views */
columnheader,
.column-header {
    background-color: shade(@theme_bg_color, 1.01);
    color: @theme_fg_color;
}

EOF
        echo "GTK4 CSS enhancements applied successfully"
    else
        echo "Warning: Could not find ${gtk4_css} to apply fixes."
    fi

    # Also ensure GTK3 compatibility for older GTK3 applications
    if [ -f "${gtk3_gtkrc}" ]; then
        echo "Applying GTK3 compatibility settings..."
        cat >> "${gtk3_gtkrc}" <<'EOF'

# Ensure file dialogs use the dark theme in GTK3
style "file-dialog-style" {
    bg[NORMAL] = @bg_color
    bg[PRELIGHT] = shade(@bg_color, 1.1)
    bg[ACTIVE] = shade(@bg_color, 0.9)
    fg[NORMAL] = @fg_color
}
widget "GtkFileChooserDialog*" style "file-dialog-style"
widget "*GtkFileChooser*" style "file-dialog-style"

EOF
        echo "GTK3 settings applied"
    fi

    # --------------------------------------------------------------------------
    # [NEW] Create post-install helper for environment setup
    # --------------------------------------------------------------------------
    install -Dm755 /dev/stdin "${pkgdir}/usr/share/${pkgname}/setup-gtk-env.sh" <<'EOFSCRIPT'
#!/usr/bin/env bash
# Post-install script to help users set up GTK_THEME environment
# Run this after installing the package to ensure proper theme application

CONFIG_DIR="${HOME}/.config"
STATE_DIR="${CONFIG_DIR}/comm-gnome-theme-everforest"
ENV_THEME_FILE="${STATE_DIR}/gtk-theme.env"
THEME_NAME="Everforest-Dark-Medium-B"

mkdir -p "${STATE_DIR}"

# Create environment file
cat > "${ENV_THEME_FILE}" <<EOF
export GTK_THEME=${THEME_NAME}
EOF

# Add to shell profiles
for shell_file in ~/.bashrc ~/.zshrc ~/.profile; do
    if [ -f "${shell_file}" ]; then
        if ! grep -q "gtk-theme.env" "${shell_file}"; then
            echo "[ -f \"${ENV_THEME_FILE}\" ] && source \"${ENV_THEME_FILE}\"" >> "${shell_file}"
        fi
    fi
done

echo "GTK_THEME environment variable configured"
EOFSCRIPT
}
