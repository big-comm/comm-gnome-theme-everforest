# Maintainer: Narayan Silva <narayan.song@gmail.com>

pkgname=comm-gnome-theme-everforest
pkgdesc="Everforest Medium Dark GNOME theme with GTK, cursors, icons and wallpaper"
pkgver=$(date +%y.%m.%d)
pkgrel=$(date +%H%M)
arch=('any')
license=('MIT')
url="https://github.com/big-comm/${pkgname}"
depends=('gtk3' 'gtk4' 'gnome-shell')
optdepends=('gnome-tweaks: For additional customization')

# Source directly from the Everforest GTK theme repository
source=(
    "git+https://github.com/Fausto-Korpsvart/Everforest-GTK-Theme.git#branch=main"
    "git+${url}.git"
)
sha256sums=('SKIP' 'SKIP')

# Automatically detect and use the correct install file
if [ -e "${pkgname}.install" ]; then
    install=${pkgname}.install
elif [ -e "pkgbuild.install" ]; then
    install=pkgbuild.install
fi

prepare() {
    cd "${srcdir}/${pkgname}" || return 1
}

build() {
    cd "${srcdir}/${pkgname}" || return 1
    # No build needed, this is a theme package
}

check() {
    cd "${srcdir}/${pkgname}" || return 1
    # Verify theme directory exists
    if [ ! -d "${srcdir}/Everforest-GTK-Theme/themes/Everforest-Dark-Medium-B" ]; then
        echo "Error: Everforest theme not found"
        return 1
    fi
}

package() {
    # Install GTK theme
    install -d "${pkgdir}/usr/share/themes"
    cp -r "${srcdir}/Everforest-GTK-Theme/themes/Everforest-Dark-Medium-B" \
        "${pkgdir}/usr/share/themes/Everforest-Dark-Medium-B"

    # Install installation script
    install -Dm755 "${srcdir}/${pkgname}/install.sh" \
        "${pkgdir}/usr/share/${pkgname}/install.sh"

    # Install wallpapers from usr/share directory
    if [ -d "${srcdir}/${pkgname}/usr/share" ]; then
        find "${srcdir}/${pkgname}/usr/share" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.heic" \) | while read -r wallpaper; do
            install -Dm644 "${wallpaper}" \
                "${pkgdir}/usr/share/backgrounds/${pkgname}/$(basename "${wallpaper}")"
        done
    fi

    # Install documentation
    install -Dm644 "${srcdir}/${pkgname}/README.md" \
        "${pkgdir}/usr/share/doc/${pkgname}/README.md"

    # Install license
    install -Dm644 "${srcdir}/${pkgname}/LICENSE" \
        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
